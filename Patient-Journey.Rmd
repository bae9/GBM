---
title: "GBM Patient Journey"
author: "Blake Easton"
date: "10/31/2019"
output: html_document
---

```{r setup, include=FALSE}
library(Hmisc)
library(tidyverse)
library(readxl)
library(knitr)
library(kableExtra)
library(dplyr)
library(magrittr)
knitr::opts_chunk$set(echo = TRUE)
```

## Data Prep

```{r data-prep}
path <- "variable-dosing_7119.xlsx"
studies <- read_excel(path, sheet="Studies")
arms <- read_excel(path, sheet="Arms")
dropout <- read_excel(path, sheet="Dropout")

studies <- studies %>%
  mutate(NCT = as.factor(NCT))

arms <- arms %>%
  mutate(NCT = as.factor(NCT)
        ,Arm = as.factor(Arm)
        )

dropout <- dropout %>%
  mutate(NCT = as.factor(NCT)
        ,Arm = as.factor(Arm)
        ,Reason = as.factor(Reason)
        )

dropout <- dropout[dropout$Reason != "None",]
dropoutsum <- dropout %>%
  group_by(NCT, Arm) %>%
    summarize(Sum = sum(Dropouts, na.rm=FALSE))

myData <- read.csv("variable-dosing_7119.csv", header = TRUE)
myData <- myData[myData$Reason.for.dropping != "None",]
```

## Integrity Checks
```{r integrity-checks}
# TODO: Try running these 'by hand' in the console.
# TODO: See https://en.wikipedia.org/wiki/Assertion_(software_development)
stopifnot(nlevels(dropout$Arm) == nlevels(arms$Arm))
duped <- dropout %>%
  group_by(Arm) %>%
  summarize(duped = length(unique(NCT)) > 1)
arm_names_unique <- all(!duped$duped)
stopifnot(all(!duped$duped))
```

## Universal IV

```{r universal-IV, fig.height=5, fig.cap="**TODO:** Caption figure."}
#sum up by arm
qty <- aggregate(myData$Qty, by=list(Category=myData$Arm.Group.Title), FUN=sum)
numpeople <- aggregate(myData$X..People, by=list(Category=myData$Arm.Group.Title), FUN=median)
cat <- aggregate(myData$Universal.IV, by=list(Category=myData$Arm.Group.Title), FUN=mean)

#build boxplot
df <- data.frame(qty, numpeople, cat)
bxp <- boxplot(df$x/df$x.1 ~ as.logical(df$x.2), data=myData,horizontal=TRUE, ylab="Use of IV", xlab="% Patient Dropout")

#add text
text(x=0.1, y=1, labels=toString(round(bxp$stats[3,1] * 100, digits=2)))
text(x=0.2, y=2, labels=toString(round(bxp$stats[3,2] * 100, digits=2)))
title(paste("% Patient Dropout rate by use of Universal IV \n n=", sum(numpeople$x), sep=""))

```

##Recurrent Patients

```{r dropout-vs-recurrence, fig.height=5, fig.cap="**TODO:** Write the figure caption here."}
df_sum <- data.frame(dropoutsum$Arm, dropoutsum$Sum)
df_arm <- data.frame(arms$Arm, arms$Enrollment, arms$Recurrent)
combo <- full_join(df_sum, df_arm, by = c("dropoutsum.Arm" = "arms.Arm" ))

bp <- boxplot(combo$dropoutsum.Sum / combo$arms.Enrollment ~ combo$arms.Recurrent, horizontal=TRUE, ylab="Recurrent Patient", xlab="% Patient Dropout")

title(paste("% Patient Dropout rate by Recurrence \n n=", sum(df_arm$arms.Enrollment), sep=""))
text(x=0.11, y=1, labels=toString(round(bp$stats[3,1] * 100, digits=2)))
text(x=0.06, y=2, labels=toString(round(bp$stats[3,2] * 100, digits=2)))
```