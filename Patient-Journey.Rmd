---
title: "GBM Patient Journey"
author: "Blake Easton"
date: "11/11/2019"
output:
  html_document: default
---

```{r setup, include=FALSE}
library(Hmisc)
library(tidyverse)
library(readxl)
library(knitr)
library(kableExtra)
library(dplyr)
library(magrittr)
library(cluster)
library(factoextra)
knitr::opts_chunk$set(echo = TRUE)
```

## Data Prep

```{r data-prep}
path <- "variable-dosing_7119.xlsx"
studies <- read_excel(path, sheet="Studies")
arms <- read_excel(path, sheet="Arms")
dropout <- read_excel(path, sheet="Dropout")

studies <- studies %>%
  mutate(NCT = as.factor(NCT))

arms <- arms %>%
  mutate(NCT = as.factor(NCT)
        ,Arm = as.factor(Arm)
        )

dropout <- dropout %>%
  mutate(NCT = as.factor(NCT)
        ,Arm = as.factor(Arm)
        ,Reason = as.factor(Reason)
        )




dropout <- dropout[dropout$Reason == "Withdrawal by Subject" | dropout$Reason == "Patient Refusal" | dropout$Reason == "Study Compliance",]
dropoutsum <- dropout %>%
  group_by(NCT, Arm) %>%
    summarize(Sum = sum(Dropouts, na.rm=FALSE))
```

## Integrity Checks
```{r integrity-checks}
stopifnot(nlevels(dropout$Arm) == nlevels(arms$Arm))
duped <- dropout %>%
  group_by(Arm) %>%
  summarize(duped = length(unique(NCT)) > 1)
arm_names_unique <- all(!duped$duped)
stopifnot(all(!duped$duped))
```

## Patient Burden (Blake)

```{r patient-burden, fig.height=5, fig.cap="TODO"}
#create data frame for kmeans
df_arm <- data.frame(arms$`Universal IV`, arms$Radiation, arms$Surgery, arms$SOC, arms$Recurrent, arms$Arm)

#scale data
rownames(df_arm) = df_arm$arms.Arm
df_arm$arms.Arm = NULL

df_arm <- na.omit(df_arm)
df_arm <- scale(df_arm)

#build cluster graph
k2 <- kmeans(df_arm, centers = 3, nstart=25, algorithm ="Forgy")
fviz_cluster(k2, data=df_arm, repel=TRUE, labelsize = 7)

#utilize k2 data / format
dfk <- data.frame(k2$cluster)

df_arm <- data.frame(arms$Arm, arms$Enrollment, arms$`Universal IV`, arms$Radiation, arms$Surgery, arms$SOC, arms$Concomitant, arms$Adjuvant, arms$Recurrent)
df_sum <- data.frame(dropoutsum$Arm, dropoutsum$Sum)
combo <- full_join(df_sum, df_arm, by = c("dropoutsum.Arm" = "arms.Arm" ))
combo <- na.omit(combo)
rownames(combo) = combo$dropoutsum.Arm

combok <- merge(combo, dfk, by=0)
percent <- combok$dropoutsum.Sum / combok$arms.Enrollment

#build boxplot
bwplot(combok$k2.cluster ~ percent)

```
## Patient Burden (Emily)

```{r patient-burden-emily, fig.height=5, fig.cap="**TODO**"}
#create data frames for combination
df_sum <- data.frame(dropoutsum$Arm, dropoutsum$Sum)
df_arm <- data.frame(arms$Arm, arms$Enrollment, arms$BurdenTwo, arms$Recurrent)

#combine data frames / make percent
combo <- full_join(df_sum, df_arm, by = c("dropoutsum.Arm" = "arms.Arm" ))
percent <- combo$dropoutsum.Sum / combo$arms.Enrollment

#sort y axis
combo$arms.BurdenTwo <- fct_relevel(combo$arms.BurdenTwo, "Low", "Medium", "High")

#build chart
bxp <- boxplot(percent ~ combo$arms.Burden, 
        horizontal = TRUE,
        xlab = "% of Patient Dropouts",
        col = "grey"
        )

stripchart(percent ~ combo$arms.Burden, 
          add = TRUE,
          pch = 20,
          method = "jitter",
          col = "blue"
          )

#format text
low <- format(round(bxp$stats[3,1], 2), nsmall = 2)
medium <- format(round(bxp$stats[3,2], 2), nsmall = 2)
high <- format(round(bxp$stats[3,3], 2), nsmall = 2)

#add text
text(x=0.15, y=1, labels=low)
text(x=0.315, y=2, labels=medium)
text(0.30, y=3, labels=high)
title("Patient Dropout % by Burden Level")

```



